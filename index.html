<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brundavanam Goshala - Order Natural Products Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.378.0/dist/lucide.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #carousel-track {
            transition: transform 0.5s ease-in-out;
        }
        .carousel-slide {
            flex-shrink: 0;
            width: 100%;
            position: relative;
        }
        #tsparticles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        /* Cart count animation */
        .cart-count-animate {
            animation: pop 0.3s ease-in-out;
        }
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.4) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        /* Spinner animation */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid currentColor;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: spin 0.75s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Custom Logo Loader */
        .loader-logo {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }
        /* Quick View Modal */
        .modal-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .modal-thumbnail-active {
            border-color: #166534; /* green-800 */
        }
        #product-grid {
            transition: opacity 0.2s ease-in-out;
        }
        /* Header shrink styles */
        #header-inner {
            transition: height 0.3s ease-in-out;
        }
        #logo-link {
            transition: font-size 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-stone-50">

    <!-- Page Loader -->
    <div id="page-loader" class="fixed inset-0 z-[9999] flex items-center justify-center bg-white transition-opacity duration-300 ease-in-out">
        <!-- Replace with the direct URL to your logo image (e.g., assets/logo.png) -->
        <img src="logo.png" alt="Brundavanam Goshala Logo" class="loader-logo w-24 h-24">
    </div>

    <div id="tsparticles"></div>

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div id="header-inner" class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <a id="logo-link" href="index.html" class="text-xl sm:text-2xl font-bold text-green-800 hover:text-green-700">Brundavanam Goshala</a>
                </div>
                <nav class="hidden md:flex items-center space-x-8 text-sm font-medium">
                    <a href="index.html" class="text-green-700 border-b-2 border-green-700">HOME</a>
                    <a href="about.html" class="text-stone-600 hover:text-green-700">ABOUT US</a>
                    <a href="contact.html" class="text-stone-600 hover:text-green-700">SUPPORT</a>
                </nav>
                <div class="flex items-center space-x-4">
                    <a href="cart.html" class="relative text-stone-600 hover:text-green-700">
                        <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                        <span id="cart-count" class="absolute -top-2 -right-2 bg-amber-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                    </a>
                    <button id="mobile-menu-button" class="md:hidden text-gray-700">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-white/80 backdrop-blur-sm border-t p-4 space-y-2">
            <a href="index.html" class="block text-gray-700 hover:bg-stone-100 p-2 rounded">Home</a>
            <a href="about.html" class="block text-gray-700 hover:bg-stone-100 p-2 rounded">About Us</a>
            <a href="contact.html" class="block text-gray-700 hover:bg-stone-100 p-2 rounded">Support</a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Advertisement Carousel -->
        <div id="advertisement-carousel" role="region" aria-roledescription="carousel" aria-label="Advertisements" class="relative w-full h-64 md:h-80 rounded-lg overflow-hidden shadow-lg mb-12 group">
            <div id="carousel-live-region" class="sr-only" aria-live="polite" aria-atomic="true"></div>
            <div id="carousel-track" class="flex h-full">
                <!-- Slides -->
                 <div class="carousel-slide" role="group" aria-roledescription="slide" aria-label="1 of 3" tabindex="-1">
                    <img src="https://placehold.co/1200x400/FBBF24/FFFFFF?text=Pure+A2+Ghee" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center text-center text-white p-4">
                        <div>
                            <h2 class="text-3xl md:text-4xl font-bold">Taste the Purity of A2 Ghee</h2>
                            <p class="mt-2 text-lg">Traditionally made for authentic flavor.</p>
                            <a href="product-detail.html?id=1" class="mt-4 inline-block bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-6 rounded-lg">Shop Now</a>
                        </div>
                    </div>
                </div>
                <div class="carousel-slide" role="group" aria-roledescription="slide" aria-label="2 of 3" tabindex="-1">
                    <img src="https://placehold.co/1200x400/34D399/FFFFFF?text=Natural+Soaps" class="w-full h-full object-cover">
                     <div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center text-center text-white p-4">
                        <div>
                            <h2 class="text-3xl md:text-4xl font-bold">Herbal Panchagavya Soaps</h2>
                            <p class="mt-2 text-lg">Nourish your skin, naturally.</p>
                            <a href="product-detail.html?id=2" class="mt-4 inline-block bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-lg">Explore Soaps</a>
                        </div>
                    </div>
                </div>
                <div class="carousel-slide" role="group" aria-roledescription="slide" aria-label="3 of 3" tabindex="-1">
                    <img src="https://placehold.co/1200x400/8B4513/FFFFFF?text=Organic+Manure" class="w-full h-full object-cover">
                     <div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center text-center text-white p-4">
                        <div>
                            <h2 class="text-3xl md:text-4xl font-bold">Enrich Your Garden</h2>
                            <p class="mt-2 text-lg">100% Organic Cow Manure.</p>
                            <a href="product-detail.html?id=3" class="mt-4 inline-block bg-stone-700 hover:bg-stone-800 text-white font-bold py-2 px-6 rounded-lg">Buy Now</a>
                        </div>
                    </div>
                </div>
            </div>
            <button id="prev-button" aria-label="Previous slide" class="absolute top-1/2 left-4 -translate-y-1/2 bg-white/50 hover:bg-white/80 rounded-full p-2 text-stone-800 opacity-0 group-hover:opacity-100 transition-opacity">
                <i data-lucide="chevron-left" class="w-6 h-6"></i>
            </button>
            <button id="next-button" aria-label="Next slide" class="absolute top-1/2 right-4 -translate-y-1/2 bg-white/50 hover:bg-white/80 rounded-full p-2 text-stone-800 opacity-0 group-hover:opacity-100 transition-opacity">
                <i data-lucide="chevron-right" class="w-6 h-6"></i>
            </button>
            <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-2" id="carousel-dots">
            </div>
        </div>

        <!-- Search and Intro -->
        <div class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-stone-800 mb-2">Pure & Natural Products</h1>
            <p class="text-stone-600">Delivered from our Goshala, straight to your home.</p>
            <div class="max-w-xl mx-auto mt-6">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="Search for Ghee, Soaps, etc." class="w-full p-4 pr-12 text-stone-700 border border-stone-300 rounded-full focus:outline-none focus:ring-2 focus:ring-green-600" autocomplete="off">
                    <button id="search-button" class="absolute top-1/2 right-4 -translate-y-1/2 text-stone-500 hover:text-green-700">
                        <i data-lucide="search" class="w-5 h-5"></i>
                    </button>
                    <div id="search-suggestions" class="absolute top-full w-full bg-white border border-stone-200 rounded-b-lg shadow-lg z-20 hidden mt-1 overflow-hidden">
                        <!-- Search suggestions will be dynamically injected here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Category Filters -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-semibold text-stone-700 text-center md:text-left">Filter by Category</h2>
                <button id="clear-filters-btn" class="text-sm text-green-700 hover:underline hidden font-medium">Clear All</button>
            </div>
            <div id="category-filters" class="flex flex-wrap justify-center md:justify-start gap-2">
                <!-- Category buttons will be dynamically inserted here -->
            </div>
        </div>

        <!-- Product Grid -->
        <div>
            <div class="flex justify-between items-center mb-4">
                <h2 id="products-heading" class="text-2xl font-bold text-stone-800">All Products</h2>
                <div class="flex items-center space-x-2 text-sm text-stone-600">
                    <span>Sort By:</span>
                    <select id="sort-select" class="font-medium bg-transparent border-none focus:ring-0">
                        <option value="relevance">Relevance</option>
                        <option value="newest">Newest Arrivals</option>
                        <option value="price-asc">Price: Low to High</option>
                        <option value="price-desc">Price: High to Low</option>
                    </select>
                </div>
            </div>
            
            <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Product cards are dynamically inserted here -->
            </div>

            <div id="load-more-container" class="text-center mt-12 hidden">
                <button id="load-more-btn" class="bg-green-700 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-800 transition-colors shadow-md">Load More Products</button>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-stone-800 text-white mt-12">
        <div class="container mx-auto px-8 py-12 text-center">
            <p class="font-bold text-2xl mb-2">Brundavanam Goshala</p>
            <p class="text-stone-400 max-w-xl mx-auto mb-6">Promoting wellness and sustainability through sacred cow products, while supporting the care and protection of our beloved Gomata.</p>
            <div class="flex justify-center space-x-6">
                 <a href="about.html" class="text-stone-300 hover:text-white">About Us</a>
                 <a href="contact.html" class="text-stone-300 hover:text-white">Contact & Support</a>
                 <a href="#" class="text-stone-300 hover:text-white">Terms of Service</a>
            </div>
        </div>
    </footer>
    
    <!-- Back to Top Button -->
    <button id="back-to-top-btn" title="Go to top" class="fixed bottom-20 right-5 z-50 p-3 rounded-full bg-green-700 text-white shadow-lg hover:bg-green-800 transition-all duration-300 opacity-0 translate-y-4 pointer-events-none">
        <i data-lucide="arrow-up" class="w-6 h-6"></i>
    </button>

    <!-- Add to Cart Notification -->
    <div id="cart-notification" class="fixed bottom-5 right-5 bg-green-700 text-white py-3 px-6 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-500 ease-in-out z-50 max-w-md">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <i data-lucide="check-circle" class="w-5 h-5 mr-3 shrink-0"></i>
                <span id="notification-message">Item added to cart!</span>
            </div>
            <a href="cart.html" class="ml-6 shrink-0 text-sm font-semibold bg-white/20 hover:bg-white/30 px-3 py-1 rounded-md">View Cart</a>
        </div>
    </div>

    <!-- Quick View Modal -->
    <div id="quick-view-modal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="quick-view-title">
        <div id="quick-view-overlay" class="absolute inset-0 bg-black/60 modal-overlay opacity-0"></div>
        <div id="quick-view-content" class="relative bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col modal-content transform scale-95 opacity-0">
            <!-- Modal content will be dynamically injected here -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tsparticles@3.1.0/tsparticles.bundle.min.js"></script>

    <script>
        // --- DATA MANAGEMENT ---
        let products = [];

        function loadProductsFromStorage() {
            const storedProducts = localStorage.getItem('goshalaProducts');
            if (storedProducts) {
                products = JSON.parse(storedProducts);
            } else {
                // Expanded product data with image galleries and reviews
                products = [
                    { 
                        id: 1, name: "Pure A2 Ghee - Traditional & Authentic (500ml)", 
                        dateAdded: "2024-01-15",
                        category: ["Food & Wellness", "Ghee", "Pooja Items"],
                        images: [
                            "https://placehold.co/600x600/FBBF24/FFFFFF?text=A2+Ghee+1",
                            "https://placehold.co/600x600/FBBF24/8B4513?text=A2+Ghee+2",
                            "https://placehold.co/600x600/FBBF24/2d5a2d?text=A2+Ghee+3"
                        ],
                        description: "Experience the authentic taste and aroma of our traditionally prepared A2 Ghee. Made from the milk of free-grazing indigenous cows, it's churned by hand to preserve its natural nutrients. Rich in vitamins and healthy fats, it's perfect for cooking, medicinal use, and spiritual practices.",
                        rating: 4, reviewsCount: 320, sellerTag: "Limited time deal", price: 750, originalPrice: 900, deliveryDate: "FREE Delivery by Tomorrow", inCart: false, quantity: 0,
                        reviews: [
                            { user: "Priya S.", rating: 5, comment: "Amazing quality and authentic taste. Reminds me of my grandmother's ghee." },
                            { user: "Rajesh K.", rating: 4, comment: "Very good product. The packaging was also excellent." }
                        ]
                    },
                    { 
                        id: 2, name: "Herbal Panchagavya Soap (100g)", 
                        dateAdded: "2024-06-20", // Recent
                        category: ["Personal Care", "Panchagavya"],
                        images: ["https://placehold.co/600x600/34D399/FFFFFF?text=Soap+1"],
                        description: "Nourish your skin with the goodness of Panchagavya. This herbal soap is handmade with natural ingredients to cleanse and rejuvenate your skin, leaving it soft and supple.",
                        rating: 5, reviewsCount: 512, sellerTag: "Best Seller", price: 150, originalPrice: 180, deliveryDate: "FREE Delivery by Tomorrow", inCart: false, quantity: 0,
                        reviews: []
                    },
                    { 
                        id: 3, name: "100% Organic Cow Manure (5kg)", 
                        dateAdded: "2023-12-01",
                        category: ["Gardening & Agriculture", "Fertilizer"],
                        images: ["https://placehold.co/600x600/8B4513/FFFFFF?text=Manure+1"],
                        description: "Enrich your garden with our 100% organic and composted cow manure. It's the perfect natural fertilizer to help your plants thrive, improving soil health and promoting vigorous growth.",
                        rating: 4, reviewsCount: 280, sellerTag: null, price: 250, originalPrice: null, deliveryDate: "FREE Delivery in 2-3 days", inCart: false, quantity: 0,
                        reviews: []
                    },
                    { 
                        id: 4, name: "Purifying Cow Dung Dhoop Sticks", 
                        dateAdded: "2024-06-15", // Recent
                        category: ["Spiritual & Home", "Pooja Items", "Incense"],
                        images: ["https://placehold.co/600x600/F59E0B/FFFFFF?text=Dhoop+1"],
                        description: "Create a sacred and pure atmosphere with these traditional Dhoop sticks made from cow dung and natural herbs. Ideal for pooja, meditation, and purifying your home.",
                        rating: 5, reviewsCount: 450, sellerTag: "Limited time deal", price: 120, originalPrice: 150, deliveryDate: "FREE Delivery by Tomorrow", inCart: false, quantity: 0,
                        reviews: []
                    }
                ];
                saveProductsToStorage();
            }
        }

        function saveProductsToStorage() {
            localStorage.setItem('goshalaProducts', JSON.stringify(products));
        }

        // --- DYNAMIC RENDERING ---
        const productGrid = document.getElementById('product-grid');
        const loadMoreContainer = document.getElementById('load-more-container');
        const loadMoreBtn = document.getElementById('load-more-btn');

        let currentFilteredProducts = [];
        let productsDisplayed = 0;
        const PRODUCTS_PER_LOAD = 8;

        function generateStars(rating) {
            let starsHTML = '';
            for (let i = 1; i <= 5; i++) starsHTML += `<i data-lucide="star" class="w-4 h-4 ${i <= rating ? 'fill-current' : 'text-stone-300 fill-current'}"></i>`;
            return starsHTML;
        }

        function getNewStatus(dateString) {
            if (!dateString) return null;

            const now = new Date();
            const productDate = new Date(dateString);
            
            if (productDate > now) return null;

            const diffTime = now - productDate;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays <= 15) {
                return 'new';
            } else if (diffDays <= 30) {
                return 'recent';
            }
            return null;
        }
        
        function appendProducts(productsToAppend) {
            if (productsToAppend.length === 0 && productsDisplayed === 0) {
                productGrid.innerHTML = `<p class="col-span-full text-center text-stone-500 py-8">No products match your criteria.</p>`;
                return;
            }

            productsToAppend.forEach(product => {
                const discount = product.originalPrice ? Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100) : 0;
                const card = document.createElement('div');
                card.className = "product-card bg-white rounded-lg shadow-md overflow-hidden flex flex-col transform hover:scale-105 transition-transform duration-300";
                
                let cartControlsHTML = '';
                if (product.inCart) {
                    cartControlsHTML = `
                        <div class="mt-auto w-full flex items-center justify-between font-bold text-lg rounded-lg border-2 border-green-700">
                           <button class="quantity-change-btn text-green-700 px-4 py-1" data-product-id="${product.id}" data-change="-1">-</button>
                           <span class="text-green-700">${product.quantity} in cart</span>
                           <button class="quantity-change-btn text-green-700 px-4 py-1" data-product-id="${product.id}" data-change="1">+</button>
                        </div>
                    `;
                } else {
                    cartControlsHTML = `<button class="add-to-cart-btn mt-auto w-full font-bold py-2 px-4 rounded-lg transition-colors bg-amber-500 text-stone-900 hover:bg-amber-600" data-product-id="${product.id}">Add to Cart</button>`;
                }

                const badges = [];
                const newStatus = getNewStatus(product.dateAdded);
                if (newStatus === 'new') {
                    badges.push(`<span class="inline-block bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded">New Arrival</span>`);
                } else if (newStatus === 'recent') {
                    badges.push(`<span class="inline-block bg-orange-500 text-white text-xs font-bold px-2 py-1 rounded">Recently Added</span>`);
                }
                if (product.originalPrice && product.originalPrice > product.price) {
                    badges.push(`<span class="inline-block bg-purple-600 text-white text-xs font-bold px-2 py-1 rounded">On Sale</span>`);
                } else if (product.sellerTag) {
                    badges.push(`<span class="inline-block bg-red-600 text-white text-xs font-bold px-2 py-1 rounded">${product.sellerTag}</span>`);
                }

                // **FIX:** Added a check to prevent error if product.images is missing or empty.
                const imageUrl = (product.images && product.images.length > 0) ? product.images[0] : 'https://placehold.co/400x300/CCCCCC/FFFFFF?text=No+Image';

                card.innerHTML = `
                    <div class="relative group">
                        <img src="${imageUrl}" alt="${product.name}" class="w-full h-48 object-cover">
                        <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <button class="quick-view-btn bg-white text-stone-800 font-bold py-2 px-4 rounded-full transform scale-90 group-hover:scale-100 transition-transform" data-product-id="${product.id}">Quick View</button>
                        </div>
                    </div>
                    <div class="p-4 flex flex-col flex-grow">
                        <p class="text-xs text-stone-500 mb-1">Brundavanam Goshala</p>
                        <h3 class="font-medium text-stone-800 leading-tight mb-2 flex-grow"><a href="product-detail.html?id=${product.id}" class="hover:text-green-700">${product.name}</a></h3>
                        <div class="flex items-center mb-2">
                             <div class="flex text-amber-500">${generateStars(product.rating)}</div>
                            <span class="text-xs text-stone-500 ml-2">(${product.reviewsCount})</span>
                        </div>
                        <div class="mb-3 h-5 flex items-center gap-2">${badges.join('')}</div>
                        <div class="flex items-baseline mb-2">
                            <span class="text-2xl font-bold text-stone-800">₹${product.price}</span>
                            ${product.originalPrice ? `<span class="text-sm text-stone-500 line-through ml-2">M.R.P: ₹${product.originalPrice}</span><span class="text-sm text-green-700 font-semibold ml-2">(${discount}% off)</span>` : ''}
                        </div>
                        <p class="text-sm text-stone-600 mb-4">${product.deliveryDate}</p>
                        <div class="cart-controls" data-product-id="${product.id}">
                            ${cartControlsHTML}
                        </div>
                    </div>`;
                productGrid.appendChild(card);
            });
            lucide.createIcons();
        }
        
        function loadMoreProducts() {
            const productsToAppend = currentFilteredProducts.slice(productsDisplayed, productsDisplayed + PRODUCTS_PER_LOAD);
            appendProducts(productsToAppend);
            productsDisplayed += productsToAppend.length;

            if (productsDisplayed >= currentFilteredProducts.length) {
                loadMoreContainer.classList.add('hidden');
            } else {
                loadMoreContainer.classList.remove('hidden');
            }
        }

        // --- MAIN LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            const cartCountElement = document.getElementById('cart-count');
            const searchInput = document.getElementById('search-input');
            const sortSelect = document.getElementById('sort-select');
            const suggestionsContainer = document.getElementById('search-suggestions');
            const clearFiltersBtn = document.getElementById('clear-filters-btn');
            let selectedCategory = 'All';
            let highlightedSuggestionIndex = -1;
            
            loadProductsFromStorage();
            renderCategoryFilters();
            loadAndApplyPreferences(); // This will also update the clear button visibility
            applyFiltersAndSort();
            updateCartCount();

            // Mobile Menu Toggle & Active Link
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden')); // Toggles the menu visibility

                const currentPath = window.location.pathname.split('/').pop() || 'index.html';
                const mobileNavLinks = mobileMenu.querySelectorAll('a');
                mobileNavLinks.forEach(link => {
                    if (link.getAttribute('href') === currentPath) {
                        link.classList.add('bg-green-100', 'text-green-800', 'font-semibold');
                    }
                });
            }

            // --- BACK TO TOP BUTTON LOGIC ---
            const backToTopBtn = document.getElementById('back-to-top-btn');
            if (backToTopBtn) {
                window.addEventListener('scroll', () => {
                    if (window.scrollY > 400) { // Show after scrolling 400px
                        backToTopBtn.classList.remove('opacity-0', 'translate-y-4', 'pointer-events-none');
                    } else {
                        backToTopBtn.classList.add('opacity-0', 'translate-y-4', 'pointer-events-none');
                    }
                });

                backToTopBtn.addEventListener('click', () => {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });
            }

            // --- HEADER SHRINK LOGIC ---
            const header = document.querySelector('header');
            const headerInner = document.getElementById('header-inner');
            const logoLink = document.getElementById('logo-link');

            if (header && headerInner && logoLink) {
                window.addEventListener('scroll', () => {
                    const isShrunk = header.classList.contains('header-shrunk');
                    if (window.scrollY > 50 && !isShrunk) {
                        header.classList.add('header-shrunk');
                        headerInner.classList.replace('h-16', 'h-14');
                        logoLink.classList.replace('text-xl', 'text-lg');
                        logoLink.classList.replace('sm:text-2xl', 'sm:text-xl');
                    } else if (window.scrollY <= 50 && isShrunk) {
                        header.classList.remove('header-shrunk');
                        headerInner.classList.replace('h-14', 'h-16');
                        logoLink.classList.replace('text-lg', 'text-xl');
                        logoLink.classList.replace('sm:text-xl', 'sm:text-2xl');
                    }
                });
            }

            loadMoreBtn.addEventListener('click', loadMoreProducts);
            
            productGrid.addEventListener('click', (event) => {
                const target = event.target;
                const quickViewBtn = target.closest('.quick-view-btn');
                if (quickViewBtn) {
                    const productId = parseInt(quickViewBtn.dataset.productId);
                    openQuickView(productId);
                    return;
                }

                const button = target.closest('.add-to-cart-btn');
                const quantityButton = target.closest('.quantity-change-btn');
                const productId = parseInt(target.closest('[data-product-id]')?.dataset.productId);

                if (!productId) return;

                const product = products.find(p => p.id === productId);
                if (!product) return;
                
                if (button && !button.disabled) {
                    button.disabled = true;
                    button.innerHTML = `<div class="spinner"></div>`;
                    button.classList.add('flex', 'justify-center', 'items-center');

                    setTimeout(() => {
                        product.inCart = true;
                        product.quantity = 1;
                        showNotification(`"${product.name.substring(0, 25)}..." added to cart!`);
                        updateProductCard(product.id);
                        updateCartCount();
                        saveProductsToStorage();
                    }, 500); // Simulate network delay
                } else if (quantityButton) {
                    const change = parseInt(quantityButton.dataset.change);
                    product.quantity += change;
                    if (product.quantity <= 0) {
                        product.inCart = false;
                        product.quantity = 0;
                    }
                    updateProductCard(product.id);
                    updateCartCount();
                    saveProductsToStorage();
                }
            });

            function updateProductCard(productId) {
                 const cardControls = document.querySelector(`.cart-controls[data-product-id="${productId}"]`);
                 const product = products.find(p => p.id === productId);
                 if (cardControls && product) {
                     if (product.inCart) {
                        cardControls.innerHTML = `
                            <div class="mt-auto w-full flex items-center justify-between font-bold text-lg rounded-lg border-2 border-green-700">
                               <button class="quantity-change-btn text-green-700 px-4 py-1" data-product-id="${product.id}" data-change="-1">-</button>
                               <span class="text-green-700">${product.quantity} in cart</span>
                               <button class="quantity-change-btn text-green-700 px-4 py-1" data-product-id="${product.id}" data-change="1">+</button>
                            </div>
                        `;
                     } else {
                         cardControls.innerHTML = `<button class="add-to-cart-btn mt-auto w-full font-bold py-2 px-4 rounded-lg transition-colors bg-amber-500 text-stone-900 hover:bg-amber-600" data-product-id="${product.id}">Add to Cart</button>`;
                     }
                 }
            }

            function updateCartCount() {
                const itemsInCart = products.filter(p => p.inCart).length;
                const currentCount = parseInt(cartCountElement.textContent);

                if (itemsInCart !== currentCount) {
                    cartCountElement.textContent = itemsInCart;
                    cartCountElement.classList.add('cart-count-animate');
                    cartCountElement.addEventListener('animationend', () => {
                        cartCountElement.classList.remove('cart-count-animate');
                    }, { once: true });
                }
            }

            // --- NOTIFICATION LOGIC ---
            let notificationTimeout;
            function showNotification(message) {
                const notification = document.getElementById('cart-notification');
                const messageElement = document.getElementById('notification-message');
                if (!notification || !messageElement) return;

                messageElement.textContent = message;
                
                lucide.createIcons({
                    nodes: [notification.querySelector('[data-lucide]')]
                });

                clearTimeout(notificationTimeout);
                notification.classList.remove('translate-y-20', 'opacity-0');

                notificationTimeout = setTimeout(() => {
                    notification.classList.add('translate-y-20', 'opacity-0');
                }, 3000);
            }

            // --- QUICK VIEW MODAL LOGIC ---
            const quickViewModal = document.getElementById('quick-view-modal');
            const quickViewOverlay = document.getElementById('quick-view-overlay');
            const quickViewContent = document.getElementById('quick-view-content');

            function openQuickView(productId) {
                const product = products.find(p => p.id === productId);
                if (!product) return;

                const discount = product.originalPrice ? Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100) : 0;
                const images = Array.isArray(product.images) ? product.images : [];
                const mainImageSrc = images.length > 0 ? images[0] : 'https://placehold.co/600x600/CCCCCC/FFFFFF?text=No+Image';

                quickViewContent.innerHTML = `
                    <button id="modal-close-btn" aria-label="Close quick view" class="absolute top-3 right-3 text-stone-500 hover:text-stone-800 z-10 p-1 rounded-full hover:bg-stone-100 transition-colors"><i data-lucide="x" class="w-7 h-7"></i></button>
                    <div class="overflow-y-auto p-6 md:p-8 grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
                        <!-- Image Gallery -->
                        <div>
                            <img id="modal-main-image" src="${mainImageSrc}" alt="${product.name}" class="w-full rounded-lg shadow-md mb-4">
                            <div id="modal-thumbnail-gallery" class="flex space-x-2">
                                ${images.map((img, index) => `<img src="${img}" alt="Thumbnail ${index+1}" class="w-16 h-16 md:w-20 md:h-20 object-cover rounded-md cursor-pointer border-2 ${index === 0 ? 'modal-thumbnail-active' : 'border-transparent'}" data-index="${index}">`).join('')}
                            </div>
                        </div>
                        <!-- Product Details -->
                        <div class="flex flex-col">
                            <h2 id="quick-view-title" class="text-2xl md:text-3xl font-bold text-stone-800 mb-2">${product.name}</h2>
                            <div class="flex items-center mb-4">
                                <div class="flex text-amber-500">${generateStars(product.rating)}</div>
                                <span class="text-sm text-stone-500 ml-2">(${product.reviewsCount} reviews)</span>
                            </div>
                            <p class="text-stone-600 mb-6 leading-relaxed text-sm">${product.description}</p>
                            <div class="flex items-baseline mb-6">
                                <span class="text-3xl font-bold text-stone-900">₹${product.price}</span>
                                ${product.originalPrice ? `<span class="text-sm text-stone-500 line-through ml-2">M.R.P: ₹${product.originalPrice}</span><span class="text-sm text-green-700 font-semibold ml-2">(${discount}% off)</span>` : ''}
                            </div>
                            <a href="product-detail.html?id=${product.id}" class="text-sm text-green-700 hover:underline font-semibold mb-6">View Full Product Details →</a>
                            <div class="modal-cart-controls mt-auto" data-product-id="${product.id}">
                                <!-- Modal cart controls will be rendered here -->
                            </div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                updateModalCartControls(product.id);

                // Show modal
                quickViewModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                setTimeout(() => {
                    quickViewOverlay.classList.add('opacity-100');
                    quickViewContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            }

            function closeQuickView() {
                quickViewOverlay.classList.remove('opacity-100');
                quickViewContent.classList.remove('scale-100', 'opacity-100');
                quickViewContent.classList.add('scale-95');

                function onTransitionEnd() {
                    quickViewModal.classList.add('hidden');
                    quickViewContent.innerHTML = '';
                    document.body.style.overflow = '';
                    quickViewModal.removeEventListener('transitionend', onTransitionEnd);
                }
                quickViewModal.addEventListener('transitionend', onTransitionEnd);
            }

            function updateModalCartControls(productId) {
                const product = products.find(p => p.id === productId);
                const controlsContainer = quickViewContent.querySelector(`.modal-cart-controls[data-product-id="${productId}"]`);
                if (!product || !controlsContainer) return;

                if (product.inCart) {
                    controlsContainer.innerHTML = `
                        <label class="font-medium text-stone-700 mb-2 block">Quantity:</label>
                        <div class="flex items-center justify-between font-bold text-lg rounded-lg border-2 border-green-700 max-w-xs">
                           <button class="modal-quantity-btn text-green-700 px-5 py-2" data-change="-1">-</button>
                           <span class="text-green-700">${product.quantity} in cart</span>
                           <button class="modal-quantity-btn text-green-700 px-5 py-2" data-change="1">+</button>
                        </div>`;
                } else {
                    controlsContainer.innerHTML = `<button class="modal-add-to-cart-btn w-full max-w-xs text-center bg-amber-500 text-stone-900 font-bold py-4 px-8 rounded-lg text-lg hover:bg-amber-600 transition-colors shadow-lg">Add to Cart</button>`;
                }
            }

            quickViewOverlay.addEventListener('click', closeQuickView);
            quickViewContent.addEventListener('click', (event) => {
                const target = event.target;
                const productId = parseInt(target.closest('[data-product-id]')?.dataset.productId);
                const product = products.find(p => p.id === productId);

                if (target.closest('#modal-close-btn')) closeQuickView();

                // Thumbnail clicks
                if (target.closest('#modal-thumbnail-gallery img')) {
                    const thumb = target.closest('img');
                    document.getElementById('modal-main-image').src = thumb.src;
                    document.querySelectorAll('#modal-thumbnail-gallery img').forEach(t => t.classList.remove('modal-thumbnail-active'));
                    thumb.classList.add('modal-thumbnail-active');
                }

                // Cart controls
                if (product) {
                    if (target.closest('.modal-add-to-cart-btn')) {
                        product.inCart = true;
                        product.quantity = 1;
                        showNotification(`"${product.name.substring(0, 25)}..." added to cart!`);
                    } else if (target.closest('.modal-quantity-btn')) {
                        const change = parseInt(target.closest('.modal-quantity-btn').dataset.change);
                        product.quantity += change;
                        if (product.quantity <= 0) {
                            product.inCart = false;
                            product.quantity = 0;
                        }
                    }
                    updateModalCartControls(productId);
                    updateProductCard(productId);
                    updateCartCount();
                    saveProductsToStorage();
                }
            });

            // Close with Escape key
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (!quickViewModal.classList.contains('hidden')) {
                        closeQuickView();
                    }
                    if (!suggestionsContainer.classList.contains('hidden')) {
                        suggestionsContainer.classList.add('hidden');
                    }
                }
            });

            // Listen for storage changes to sync cart across tabs
            window.addEventListener('storage', (event) => {
                if (event.key === 'goshalaProducts') {
                    // Data has changed in another tab, reload and re-render
                    loadProductsFromStorage(); // Updates the global `products` array
                    applyFiltersAndSort();     // Re-renders product cards based on new data
                    updateCartCount();         // Updates the header cart count
                }
            });

            function updateClearButtonVisibility() {
                const isSearchActive = searchInput.value.trim() !== '';
                const isCategoryActive = selectedCategory !== 'All';
                const isSortActive = sortSelect.value !== 'relevance';

                if (isSearchActive || isCategoryActive || isSortActive) {
                    clearFiltersBtn.classList.remove('hidden');
                } else {
                    clearFiltersBtn.classList.add('hidden');
                }
            }

            function loadAndApplyPreferences() {
                const urlParams = new URLSearchParams(window.location.search);

                const savedSearch = (urlParams.get('q') ?? localStorage.getItem('goshalaSearch')) || '';
                const savedCategory = (urlParams.get('category') ?? localStorage.getItem('goshalaCategory')) || 'All';
                const savedSort = (urlParams.get('sort') ?? localStorage.getItem('goshalaSort')) || 'relevance';
                
                searchInput.value = savedSearch;
                sortSelect.value = savedSort;
                selectedCategory = savedCategory;

                // Update category buttons UI to reflect loaded preference
                document.querySelectorAll('.category-filter-btn').forEach(btn => {
                    if (!btn) return;
                    const isActive = btn.dataset.category === selectedCategory;
                    btn.classList.toggle('bg-green-700', isActive);
                    btn.classList.toggle('text-white', isActive);
                    btn.classList.toggle('bg-stone-200', !isActive);
                    btn.classList.toggle('text-stone-700', !isActive);
                });
                updateClearButtonVisibility();
            }

            function updateUrlState() {
                const params = new URLSearchParams();
                const query = searchInput.value.trim();
                if (query) params.set('q', query);

                if (selectedCategory !== 'All') params.set('category', selectedCategory);

                const sort = sortSelect.value;
                if (sort !== 'relevance') params.set('sort', sort);

                const queryString = params.toString();
                const newUrl = queryString ? `${window.location.pathname}?${queryString}` : window.location.pathname;
                history.replaceState({ path: newUrl }, '', newUrl);
            }

            function renderCategoryFilters() {
                const filtersContainer = document.getElementById('category-filters');
                if (!filtersContainer) return;
                const allCategories = products.flatMap(p => p.category || []).filter(Boolean);
                const categories = ['All', ...new Set(allCategories)];
                
                filtersContainer.innerHTML = categories.map(category => `
                    <button class="category-filter-btn px-4 py-2 text-sm font-medium rounded-full transition-colors ${category === 'All' ? 'bg-green-700 text-white' : 'bg-stone-200 text-stone-700 hover:bg-stone-300'}" data-category="${category}">
                        ${category}
                    </button>
                `).join('');
            }

            const filtersContainer = document.getElementById('category-filters');
            if (filtersContainer) {
                filtersContainer.addEventListener('click', (event) => {
                    const button = event.target.closest('.category-filter-btn');
                    if (!button) return;

                    selectedCategory = button.dataset.category;
                    localStorage.setItem('goshalaCategory', selectedCategory);

                    document.querySelectorAll('.category-filter-btn').forEach(btn => {
                        const isActive = btn.dataset.category === selectedCategory;
                        btn.classList.toggle('bg-green-700', isActive);
                        btn.classList.toggle('text-white', isActive);
                        btn.classList.toggle('bg-stone-200', !isActive);
                        btn.classList.toggle('text-stone-700', !isActive);
                    });

                    applyFiltersAndSort();
                });
            }

            function handleSearch() {
                // --- Suggestion Logic ---
                localStorage.setItem('goshalaSearch', searchInput.value);
                highlightedSuggestionIndex = -1; // Reset on new input
                const query = searchInput.value.toLowerCase().trim();
                if (query.length > 1) {
                    const matchedProducts = products.filter(p => 
                        p.name.toLowerCase().includes(query) || 
                        (Array.isArray(p.category) && p.category.some(cat => cat.toLowerCase().includes(query)))
                    ).slice(0, 5);
                    if (matchedProducts.length > 0) {
                        suggestionsContainer.innerHTML = matchedProducts.map(product => {
                            const imageUrl = (product.images && product.images.length > 0) ? product.images[0] : 'https://placehold.co/100x100/CCCCCC/FFFFFF?text=No+Img';
                            
                            // Sanitize query for regex and create a case-insensitive regex
                            const escapedQuery = query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                            const regex = new RegExp(escapedQuery, 'gi');
                            const highlightedName = product.name.replace(regex, (match) => `<strong class="font-bold text-green-700">${match}</strong>`);

                            return `
                                <a href="product-detail.html?id=${product.id}" class="flex items-center p-3 hover:bg-stone-100 transition-colors border-t border-stone-100 first:border-t-0">
                                    <img src="${imageUrl}" alt="${product.name}" class="w-12 h-12 object-cover rounded-md mr-4">
                                    <div>
                                        <p class="font-medium text-stone-800 text-sm leading-tight">${highlightedName}</p>
                                        <p class="text-sm font-bold text-stone-700">₹${product.price}</p>
                                    </div>
                                </a>
                            `;
                        }).join('');
                        suggestionsContainer.classList.remove('hidden');
                    } else {
                        suggestionsContainer.innerHTML = '<p class="p-3 text-stone-500 text-sm">No products found.</p>';
                        suggestionsContainer.classList.remove('hidden');
                    }
                } else {
                    suggestionsContainer.classList.add('hidden');
                }
                // --- Grid Filtering Logic ---
                applyFiltersAndSort();
            }

            function applyFiltersAndSort() {
                productGrid.classList.add('opacity-0');

                // Use a timeout to allow the fade-out transition to complete before re-rendering
                setTimeout(() => {
                    const query = searchInput.value.toLowerCase();
                    let filteredProducts = products.filter(p => 
                        p.name.toLowerCase().includes(query) || 
                        (Array.isArray(p.category) && p.category.some(cat => cat.toLowerCase().includes(query)))
                    );

                    if (selectedCategory !== 'All') {
                        filteredProducts = filteredProducts.filter(p => 
                            Array.isArray(p.category) && p.category.includes(selectedCategory)
                        );
                    }
                    const sortValue = sortSelect.value;
                    if (sortValue === 'price-asc') filteredProducts.sort((a, b) => a.price - b.price);
                    else if (sortValue === 'price-desc') filteredProducts.sort((a, b) => b.price - a.price);
                    else if (sortValue === 'newest') filteredProducts.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));
                    
                    currentFilteredProducts = filteredProducts;
                    productGrid.innerHTML = '';
                    productsDisplayed = 0;
                    loadMoreProducts();
                    updateClearButtonVisibility();

                    updateUrlState();

                    // Fade the grid back in
                    productGrid.classList.remove('opacity-0');
                }, 200); // Duration should match the CSS transition
            }

            clearFiltersBtn.addEventListener('click', () => {
                searchInput.value = '';
                sortSelect.value = 'relevance';
                selectedCategory = 'All';

                localStorage.removeItem('goshalaSearch');
                localStorage.removeItem('goshalaCategory');
                localStorage.removeItem('goshalaSort');

                // Manually update category buttons UI since we are not in the filter click handler
                document.querySelectorAll('.category-filter-btn').forEach(btn => {
                    const isActive = btn.dataset.category === 'All';
                    btn.classList.toggle('bg-green-700', isActive);
                    btn.classList.toggle('text-white', isActive);
                    btn.classList.toggle('bg-stone-200', !isActive);
                    btn.classList.toggle('text-stone-700', !isActive);
                });

                applyFiltersAndSort();
            });

            searchInput.addEventListener('input', handleSearch);
            sortSelect.addEventListener('change', () => {
                localStorage.setItem('goshalaSort', sortSelect.value);
                applyFiltersAndSort();
            });

            // Keyboard navigation for search suggestions
            searchInput.addEventListener('keydown', (e) => {
                const suggestions = Array.from(suggestionsContainer.querySelectorAll('a'));
                const isSuggestionsVisible = !suggestionsContainer.classList.contains('hidden');

                if (!isSuggestionsVisible || (suggestions.length === 0 && e.key !== 'Escape')) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    highlightedSuggestionIndex = (highlightedSuggestionIndex + 1) % suggestions.length;
                    updateSuggestionHighlight(suggestions);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    highlightedSuggestionIndex = (highlightedSuggestionIndex - 1 + suggestions.length) % suggestions.length;
                    updateSuggestionHighlight(suggestions);
                } else if (e.key === 'Enter' && highlightedSuggestionIndex > -1) {
                    e.preventDefault();
                    suggestions[highlightedSuggestionIndex].click();
                }
            });

            function updateSuggestionHighlight(suggestions) {
                suggestions.forEach((suggestion, index) => {
                    if (index === highlightedSuggestionIndex) {
                        suggestion.classList.add('bg-stone-100');
                        suggestion.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                    } else {
                        suggestion.classList.remove('bg-stone-100');
                    }
                });
            }

            // Hide suggestions when clicking outside
            document.addEventListener('click', (event) => {
                const searchContainer = searchInput.parentElement;
                if (!searchContainer.contains(event.target)) {
                    suggestionsContainer.classList.add('hidden');
                }
            });

            // --- CAROUSEL LOGIC ---
            const carousel = document.getElementById('advertisement-carousel');
            const track = document.getElementById('carousel-track');
            const prevButton = document.getElementById('prev-button');
            const nextButton = document.getElementById('next-button');
            const dotsContainer = document.getElementById('carousel-dots');
            const liveRegion = document.getElementById('carousel-live-region');

            const originalSlides = Array.from(track.children);
            const originalSlideCount = originalSlides.length;
            
            const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

            // Create dots
            for (let i = 0; i < originalSlideCount; i++) {
                const dot = document.createElement('button');
                dot.setAttribute('aria-label', `Go to slide ${i + 1}`);
                dot.classList.add('carousel-dot', 'h-3', 'w-3', 'rounded-full', 'transition-colors');
                dot.addEventListener('click', () => moveToSlide(i + 1, true));
                dotsContainer.appendChild(dot);
            }

            // Clone for infinite loop
            const firstClone = originalSlides[0].cloneNode(true);
            firstClone.setAttribute('aria-hidden', 'true');
            const lastClone = originalSlides[originalSlides.length - 1].cloneNode(true);
            lastClone.setAttribute('aria-hidden', 'true');

            // Make cloned slide content non-focusable
            Array.from(firstClone.querySelectorAll('a, button')).forEach(el => el.tabIndex = -1);
            Array.from(lastClone.querySelectorAll('a, button')).forEach(el => el.tabIndex = -1);

            track.appendChild(firstClone);
            track.insertBefore(lastClone, originalSlides[0]);

            let currentSlide = 1;
            let isTransitioning = false;
            let slideInterval;

            function setInitialPosition() {
                track.style.transition = 'none';
                track.style.transform = `translateX(-${currentSlide * 100}%)`;
            }

            function updateSlideState(isManual) {
                const allSlides = Array.from(track.children);
                const activeDotIndex = (currentSlide - 1 + originalSlideCount) % originalSlideCount;

                // Update aria-hidden on all slides and focusability of their content
                allSlides.forEach((slide, index) => {
                    const isActive = index === currentSlide;
                    slide.setAttribute('aria-hidden', !isActive);
                    Array.from(slide.querySelectorAll('a, button')).forEach(el => el.tabIndex = isActive ? 0 : -1);
                });

                // Announce new slide to screen readers
                const activeSlide = originalSlides[activeDotIndex];
                const slideTitle = activeSlide.querySelector('h2').textContent;
                liveRegion.textContent = `Item ${activeDotIndex + 1} of ${originalSlideCount}: ${slideTitle}`;

                // Move focus on manual interaction
                if (isManual) {
                    activeSlide.focus();
                }
            }

            function updateDots() {
                const dots = Array.from(dotsContainer.children);
                const activeDotIndex = (currentSlide - 1 + originalSlideCount) % originalSlideCount;
                dots.forEach((dot, i) => {
                    dot.classList.toggle('bg-white', i === activeDotIndex);
                    dot.classList.toggle('bg-white/50', i !== activeDotIndex);
                    i === activeDotIndex ? dot.setAttribute('aria-current', 'true') : dot.removeAttribute('aria-current');
                });
            }
            
            function moveToSlide(slideIndex, isManual = false) {
                if (isTransitioning) return;
                isTransitioning = true;
                currentSlide = slideIndex;
                track.style.transition = prefersReducedMotion ? 'none' : 'transform 0.5s ease-in-out';
                track.style.transform = `translateX(-${currentSlide * 100}%)`;
                updateDots();

                if (prefersReducedMotion) {
                    handleInfiniteLoop();
                    updateSlideState(isManual);
                    isTransitioning = false;
                }
            }

            function handleInfiniteLoop() {
                if (currentSlide === 0) {
                    currentSlide = originalSlideCount;
                    setInitialPosition();
                } else if (currentSlide === originalSlideCount + 1) {
                    currentSlide = 1;
                    setInitialPosition();
                }
            }
            
            function startSlideShow() {
                if (prefersReducedMotion) return;
                slideInterval = setInterval(() => {
                    moveToSlide(currentSlide + 1);
                }, 3000);
            }

            function stopSlideShow() {
                clearInterval(slideInterval);
            }

            // Event Listeners
            track.addEventListener('transitionend', () => {                
                if (currentSlide === 0) { // Jump from last clone to real last slide
                    currentSlide = originalSlideCount;
                    track.style.transition = 'none';
                    track.style.transform = `translateX(-${currentSlide * 100}%)`;
                } else if (currentSlide === originalSlideCount + 1) { // Jump from first clone to real first slide
                    currentSlide = 1;
                    track.style.transition = 'none';
                    track.style.transform = `translateX(-${currentSlide * 100}%)`;
                }
                
                updateSlideState(false);
                isTransitioning = false; // Allow next transition
            });

            nextButton.addEventListener('click', () => moveToSlide(currentSlide + 1, true));
            prevButton.addEventListener('click', () => moveToSlide(currentSlide - 1, true));
            
            carousel.addEventListener('mouseenter', stopSlideShow);
            carousel.addEventListener('mouseleave', startSlideShow);
            
            // Touch Controls
            let touchStartX = 0;
            track.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                stopSlideShow();
            });

            track.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].clientX;
                const swipeThreshold = 50;
                if (touchStartX - touchEndX > swipeThreshold) {
                    moveToSlide(currentSlide + 1, true);
                } else if (touchEndX - touchStartX > swipeThreshold) {
                    moveToSlide(currentSlide - 1, true);
                }
                startSlideShow();
            });

            // Initial Setup
            setInitialPosition();
            updateSlideState(false);
            startSlideShow();
            updateDots();
        });

        // --- PAGE LOADER LOGIC ---
        const pageLoader = document.getElementById('page-loader');
        // On page load, fade out the loader
        document.addEventListener('DOMContentLoaded', () => {
            if (pageLoader) {
                pageLoader.classList.add('opacity-0');
                // After the transition, hide it so it doesn't block interactions
                setTimeout(() => {
                    pageLoader.style.display = 'none';
                }, 300); // Match duration-300
            }
        });
        // Before leaving the page, show the loader
        window.addEventListener('beforeunload', () => {
            if (pageLoader) {
                pageLoader.style.display = 'flex';
            }
        });
    </script>
</body>
</html>
